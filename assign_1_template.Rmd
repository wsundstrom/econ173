---
title: ''
output:
  html_document:
    fig_height: 3
    fig_width: 6
    highlight: textmate
    theme: cerulean
---

```{r setup, echo=FALSE, message=F, warning=F  }

#=================================================================================
#   This setup chunk is used for every assignment: 
#   Modify line #24, leave the rest alone, and skip down to line #73!
#=================================================================================

  # Clear the working space
    rm(list = ls())
  
  # The following is the path to your desired working directory:
  # Change just this command line (#24) and then skip down to line #73
  
    MyDir = "/your path/Econ173/data" 
  
### Leave the rest of this chunk alone, unless you need to add a package
  
  # Sundstrom directory (leave this alone!)
    SundstromDir <- "/Users/wsundstrom/Library/CloudStorage/GoogleDrive-wsundstrom@scu.edu/My Drive/Econ173/data"
  
  # Choose correct working directory and proceed
    if (file.exists(SundstromDir)){
      WorkDir = SundstromDir
    } else {
      WorkDir = MyDir
    }
    
  # Set working directory 
    setwd(WorkDir)
    
### Load the packages (all must have been installed)
    library(knitr)
    library(AER)
    library(sandwich)
    library(tidyverse)  
    library(plm)
    library(haven)
    library(readxl)
    library(modelsummary)
    library(lfe)
    library(ivreg)
    
### More settings
  
  # Root directory for knitr
    opts_knit$set(root.dir = WorkDir)
  
  # turn off scientific notation except for big numbers
    options(scipen = 9)
  # set font size for ggplot (default is 12)
    theme_set(theme_gray(base_size = 12))
  
```

<base target="_top"/>

ECON 173 Assignment #1\
Name: Bill Sundstrom\
December 19, 2023

--- 

### Assignment #1: Getting started with R and R Markdown

This template shows you how to set up your ECON 173 data analysis assignments in R Markdown. When you "knit" your Rmd file, Markdown will create an HTML file with your text and any R results generated by the code "chunks." You can control the size of the font for headers, as well as use _italics_ or **bold**. Learn more about formatting by going to Help (at top of screen) \> Markdown Quick Reference.

All data assignments must be submitted as **two files**: the markdown script (Rmd), and the HTML file created when you knit the Rmd.

Markdown has lots of features. For instance, you can create nice-looking equations:

$$elasticity = \epsilon = \frac{dQ_d/Q_d}{dP/P} = \frac{dln(Q_d)}{dln(P)}.$$

--- 

#### Collaboration statement

**You must include a statement such as this one with every data analysis assignment. The following is just an example.**

On this assignment, I consulted with my fellow students *Name1, Name2...* and also used ChatGPT to help with coding. They were particularly helpful in *[tasks]*. The write-up of the results represents my own ideas in my own words, and I have checked all the coding to make sure it works and that I understand what it does.

--- 

#### Plots and tables

Let's run some chunks of code and have Markdown show the results of a plot and a regression table. Of course we need to start with some data to analyze. So in the first chunk of code we start by reading in and manipulating the data. In this case we will use the familiar *caschool* data used in ECON 41/42.

In the Rmd file, you will see the option `echo=T` at the beginning of this chunk. That means that the code itself will be printed in the document, as well as any output produced by the code. Until further notice, **you should keep `echo=T` for all your code chunks after the first "setup" chunk.** That way I can see your coding and identify mistakes.

[Later in the quarter, we may switch to `echo=F`, in which case only output, such as tables or plots, will be printed in the document, but not the code. This makes for a better-looking report.]

I'll explain the other markdown options in class.

Here's the code to read the data:

```{r, results='asis', message=F, warning=F, comment=NA, echo=T}

### Data input and manipulation using "tidy" packages 

    caschool <- read_csv("caschool.csv") %>%
      mutate(lnavginc = log(avginc))
  
```

Here's the code to plot district test score against student-teacher ratio (str):

```{r, results='asis', message=F, warning=F, comment=NA, echo=T}
  
  # scatter plot of test score against average income in district
    plot1 <- caschool %>% 
      ggplot(aes(x=str, y=testscr)) +
      geom_point(shape=1) +    # Use hollow circles
      geom_smooth(method=lm, se=F) +    # add regression line
      labs(y = "Test score", x = "Student-teacher ratio" , title = "CA test scores") 
    plot1

```

--- 

Note that you can also evaluate R code in-line. For example, the covariance of *testscr* and *avginc* is `r round(cov(caschool$testscr,caschool$avginc),2)`.

--- 

#### Tables

Now let's make a table of summary statistics and a table of regression results. For reasons I will explain in class, we will use a regression command called `lm_robust( )` for basic OLS regressions. It has exactly the same syntax as `lm( )`. And for tables we will use a package called `modelsummary` (instead of `stargazer`). It includes a command to make simple tables of summary statistics, called `datasummary_skim`.

```{r, results='asis', message=F, warning=F, comment=NA, echo=T}

### summary statistics: 

  # this will only show variables that are numerical
    datasummary_skim(caschool,
                     title = "CA School Data Summary Statistics")

  # for a summary of just the categorical variables, add option type = "categorical"

### regressions

    reg1 <- lm(testscr ~ str , data = caschool)
    reg2 <- lm(testscr ~ str + lnavginc, data = caschool)

  # Now make the table of results using modelsummary
    models1 <- list(reg1, reg2)
    modelsummary(models1, 
                 vcov = "robust",         # correct SEs for heteroskedasticity
                 stars=T, gof_map = c("nobs", "adj.r.squared"),
                 title = "Regressions",
                 output="default")
   
### all of the following code provides examples of modifications to modelsummary tables
    
  # to change the column headers 
    models2 <- dvnames(list(reg1, reg2))              # this uses dependent var names as column headers
    models3 <- list("Simple" = reg1, "Mult" = reg2)   # this assigns custom column headers

  # to subset and/or rename regressors: coefmap
    modelsummary(models1,
                 vcov = "robust",
                 coef_map = c("str"="Student-teacher ratio"),
                 stars=T, gof_map = c("nobs", "adj.r.squared"),
                 title = "Regressions",
                 output="default")
    
  # to include 95% CI in table instead of SE, drop stars
    modelsummary(models1,
                 vcov = "robust",
                 statistic = c("conf.int"),
                 coef_map = c("str"="Student-teacher ratio"),
                 gof_map = c("nobs", "adj.r.squared"),
                 title = "Regressions",
                 output="default")
    
  # plot 95% CIs of selected coefficients -- this builds on ggplot2
    modelplot(models1, 
              vcov = "robust",
              coef_map = c("str" = "")) + 
      xlab("Class size effect (slope on str)") +
      theme_bw(base_size = 14)
  
```

--- 

#### Discussion

Finish up your report with interpretations of your results, and draw any conclusions.

--- 
